# TLS通信の鍵の仕組みとやり取り

## 各種鍵の説明

### 1. 公開鍵（Public Key）
- サーバーが所有し、誰にでも公開する鍵
- データを暗号化することはできるが、復号はできない
- 例え：誰でも閉められるが、特別な鍵がないと開けられない南京錠

### 2. 秘密鍵（Private Key）
- サーバーのみが保有する非公開の鍵
- 公開鍵で暗号化されたデータを復号できる唯一の鍵
- 例え：南京錠を開けられる特別な鍵（サーバーだけが持っている）

### 3. セッション鍵（Session Key）
- 一回の通信セッションでのみ使用される一時的な鍵
- ブラウザが生成し、公開鍵暗号方式でサーバーと安全に共有
- 通信の双方向で同じ鍵を使って暗号化・復号（対称暗号）
- 例え：特別な箱の鍵（ブラウザとサーバーの両方が持っている）

## TLS通信のやり取り図とタイミング

```
ブラウザ                                    サーバー
  |                                            |
  |  1. 接続開始（クライアントハロー）          |  ← ユーザーがURLを入力し、TCPコネクション確立直後
  | -----------------------------------------> |
  |                                            |
  |  2. サーバーハロー＋証明書（公開鍵を含む）   |  ← クライアントハロー受信後すぐ（数ミリ秒以内）
  | <----------------------------------------- |
  |                                            |
  |  3. 証明書を検証                           |  ← 証明書受信後すぐ（数ミリ秒以内）
  |     セッション鍵を生成                      |
  |     セッション鍵を公開鍵で暗号化             |
  |                                            |
  |  4. 暗号化されたセッション鍵を送信           |  ← 証明書検証・鍵生成完了後すぐ
  | -----------------------------------------> |
  |                                            |
  |  5. 秘密鍵でセッション鍵を復号               |  ← 暗号化されたセッション鍵受信後すぐ
  |                                            |
  |  6. 暗号化通信の準備完了通知                |  ← セッション鍵復号後すぐ
  | <----------------------------------------- |
  |                                            |
  |  7. 以降の双方向通信はセッション鍵で暗号化/復号 |  ← ハンドシェイク完了後（実際のWebコンテンツ転送）
  | <========================================> |
  |                                            |
```

## ハンドシェイクと実際のページ表示のタイミング

1. **ハンドシェイク（ステップ1～6）の特徴**:
   - Webページのコンテンツ転送前に必ず実行される前提条件
   - 通常100～300ミリ秒で完了する準備段階
   - ページ読み込みの初期段階で、ユーザーには短い待機時間として感じられる

2. **ハンドシェイク完了とコンテンツ表示の関係**:
   - ハンドシェイク（1～6）完了 → 安全な通信チャネル確立
   - 暗号化されたHTTPリクエスト送信
   - 暗号化されたHTTPレスポンス受信
   - コンテンツの復号・解析・レンダリング
   - Webページ表示

3. **重要ポイント**:
   - Webページが表示された時点では、ハンドシェイク（1～6）は必ず完了している
   - 表示されているページのすべての通信は、既にセッション鍵による暗号化（ステップ7）段階にある
   - TLSハンドシェイクはHTTPSによるWebページ表示の「入場券」のようなもの

## 実際の通信フロー

1. **初期接続（ハンドシェイク開始）**：
   - ブラウザ：「https://example.com に接続したいです」
   - サーバー：「こちらが私の身分証明書（証明書）と公開鍵です」

2. **セッション鍵の確立**：
   - ブラウザ：「証明書を確認しました。信頼できますね。セッション鍵を作成しました」
   - ブラウザ：「このセッション鍵をあなたの公開鍵で暗号化して送ります」
   - サーバー：「受け取りました。秘密鍵で復号してセッション鍵を取り出しました」

3. **安全な通信の開始**：
   - サーバー：「セッション鍵による暗号化通信の準備ができました」
   - ブラウザ：「了解しました」

4. **以降の通信（Webページ表示）**：
   - ブラウザ→サーバー：「セッション鍵で暗号化したHTTPリクエストです」
   - サーバー：「セッション鍵で復号して内容を確認しました」
   - サーバー→ブラウザ：「セッション鍵で暗号化したHTTPレスポンス（HTML等）です」
   - ブラウザ：「セッション鍵で復号してコンテンツを表示します」

## 処理時間の目安

- TLSハンドシェイク全体（ステップ1～6）: 約100～300ミリ秒
- 再接続の場合（TLSセッション再開機能使用時）: 約20～50ミリ秒
- Webページ全体の読み込み: 数百ミリ秒～数秒（ページの複雑さによる）

このように、TLS通信では最初に公開鍵・秘密鍵による安全なハンドシェイクを完了させ、その後はセッション鍵による効率的な暗号化通信でWebコンテンツを転送します。Webページが表示される時点では、ハンドシェイクは必ず完了しており、セッション鍵による安全な通信が確立されています。