# マイクロサービスベースRAGチャットボットの認証アーキテクチャ

## 全体構成

このアーキテクチャは、OAuth 2.0（JWTトークン）とmTLSを組み合わせたセキュアなマイクロサービス構成です。主要コンポーネントは以下のとおりです：

1. **クライアントアプリケーション**: ユーザーインターフェースを提供
2. **認証サーバー（Keycloak）**: OAuth 2.0フローを管理し、JWTトークンを発行
3. **API Gateway**: トークン検証と内部サービスへのルーティングを担当
4. **マイクロサービス群**:
   - Chatbotサービス: ユーザーとの対話を管理
   - Knowledge Baseサービス: ベクトル検索を提供
   - LLMサービス: 大規模言語モデルとの連携

## 認証フロー

### 外部認証（OAuth 2.0/JWT）
1. クライアントが認証サーバー（Keycloak）に認証リクエストを送信
2. Keycloakが認証を処理し、JWTトークンを発行
3. クライアントはJWTトークン付きでAPI Gatewayにリクエスト
4. API GatewayがPyJWTライブラリを使用してトークンを検証:
   - JWTの抽出
   - JWKSエンドポイントから公開鍵取得
   - 署名検証
   - 有効期限など各種クレーム検証
5. 検証成功時、API GatewayがChatbotサービスにリクエストを転送

### 内部認証（mTLS）
1. Kubernetes内のマイクロサービス間通信はすべてmTLSで保護
2. Istioなどのサービスメッシュが自動的にmTLS通信を管理:
   - 証明書の生成と管理
   - 通信の暗号化
   - サービス同士の相互認証

## 技術スタック

- **認証**: OAuth 2.0、JWT、PyJWT（検証ライブラリ）
- **サービス間通信**: mTLS（相互TLS）
- **サービスメッシュ**: Istio
- **コンテナオーケストレーション**: Kubernetes
- **認証サーバー**: Keycloak

## セキュリティの特長

1. **多層防御**: 外部はOAuth/JWT、内部はmTLSによる二重の保護
2. **責任分離**: 認証はKeycloak、サービス間通信保護はサービスメッシュが担当
3. **自動化された証明書管理**: サービスメッシュによる証明書のライフサイクル管理
4. **標準化された認証**: 業界標準のプロトコルとライブラリの活用

## 実装の簡素化

- JWTの検証は**PyJWT**ライブラリが自動処理
- mTLSは**Istio**などのサービスメッシュが自動管理
- 開発者は複雑な暗号処理を実装する必要なし

このアーキテクチャにより、RAGチャットボットのマイクロサービスは高いセキュリティを保ちながら、開発と運用の複雑さを最小限に抑えることができます。